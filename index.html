<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XIAOHE.IMG - ç§äººå›¾åºŠ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #111827; background-image: linear-gradient(135deg, #111827 0%, #1f2937 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #fff; }
        .top-nav { width: 100%; max-width: 700px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-top: 10px; }
        .logo-section { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .logo-icon { width: 36px; height: 36px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .logo-text { font-family: 'Arial Black', sans-serif; font-size: 1.8rem; font-weight: 900; text-transform: uppercase; background: linear-gradient(to right, #f59e0b, #fcd34d); -webkit-background-clip: text; background-clip: text; color: transparent; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .nav-btn { background: rgba(255, 255, 255, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.4); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .container { width: 100%; max-width: 700px; background: #ffffff; border-radius: 16px; padding: 40px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4); text-align: center; color: #333; }
        #file-input { display: none; }
        .upload-area { display: block; border: 2px dashed #e5e7eb; border-radius: 12px; padding: 60px 20px; cursor: pointer; background: #f9fafb; transition: 0.3s; margin-bottom: 20px; }
        .upload-area:hover { border-color: #f59e0b; background: #fffbeb; }
        .upload-hint { color: #6b7280; font-size: 1.1rem; pointer-events: none; }
        .progress-bar { width: 100%; height: 8px; background: #f3f4f6; border-radius: 4px; margin-bottom: 20px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; width: 0%; background: #10b981; transition: width 0.2s; }
        .upload-btn { background: linear-gradient(to right, #f59e0b, #fbbf24); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; float: right; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3); }
        .upload-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        .file-info { text-align: left; margin-bottom: 10px; color: #666; font-size: 0.9rem; min-height: 20px; clear: both; }
        .result-area { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #e5e7eb; clear: both; }
        .success-text { color: #10b981; margin-bottom: 15px; font-weight: bold; font-size: 1.2rem; }
        .preview-img { max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 20px; object-fit: contain; }
        .link-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; text-align: left; }
        select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; }
        .copy-row { display: flex; gap: 10px; }
        .copy-row input { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; }
        .copy-btn { background: #10b981; color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #log-msg { margin-top: 10px; font-size: 0.9rem; text-align: left; }
        #album-view { display: none; text-align: left; }
        .album-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .album-title { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .back-btn { background: #f3f4f6; color: #333; border: 1px solid #ddd; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .album-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid #eee; background: #fafafa; cursor: pointer; }
        .album-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .album-item:hover img { transform: scale(1.1); }
        .album-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 0.8rem; padding: 5px; text-align: center; opacity: 0; transition: opacity 0.2s; }
        .album-item:hover .album-overlay { opacity: 1; }
        .admin-link { font-size: 0.8rem; color: #666; text-decoration: none; margin-top: 20px; display: inline-block; }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="logo-section" onclick="showUpload()">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 16L8.586 11.414C8.961 11.04 9.47 10.828 10 10.828C10.53 10.828 11.039 11.04 11.414 11.414L16 16M14 14L15.586 12.414C15.961 12.04 16.47 11.828 17 11.828C17.53 11.828 18.039 12.04 18.414 12.414L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="url(#paint0_linear)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <defs><linearGradient id="paint0_linear" x1="4" y1="4" x2="20" y2="20" gradientUnits="userSpaceOnUse"><stop stop-color="#F59E0B"/><stop offset="1" stop-color="#FBBF24"/></linearGradient></defs>
            </svg>
            <span class="logo-text">XIAOHE.IMG</span>
        </div>
        <button class="nav-btn" onclick="showAlbum()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/><path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1zM2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1h-10z"/></svg>
            æˆ‘çš„ç›¸å†Œ
        </button>
    </nav>

    <main class="container">
        <div id="upload-view">
            <input type="file" id="file-input" accept="image/*" />
            <label for="file-input" class="upload-area" id="drop-area"><p class="upload-hint">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤åŒºåŸŸ</p></label>
            <div class="progress-bar" id="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <div class="file-info" id="file-info"></div>
            <button class="upload-btn" id="upload-btn" disabled>ç«‹å³ä¸Šä¼ </button>
            <div id="log-msg"></div>
            <div class="result-area" id="result-area">
                <div class="success-text">ä¸Šä¼ æˆåŠŸ</div>
                <img id="preview" class="preview-img" src="" alt="é¢„è§ˆ" />
                <div class="link-box">
                    <select id="link-format">
                        <option value="raw">å›¾ç‰‡ç›´é“¾ (URL)</option>
                        <option value="bbcode">BBCode (è®ºå›)</option>
                        <option value="markdown">Markdown (åšå®¢)</option>
                        <option value="html">HTML (ç½‘é¡µ)</option>
                    </select>
                    <div class="copy-row"><input type="text" id="link-text" readonly /><button class="copy-btn" id="copy-btn">å¤åˆ¶</button></div>
                </div>
            </div>
        </div>
        <div id="album-view">
            <div class="album-header"><span class="album-title">æˆ‘çš„ç›¸å†Œ</span><button class="back-btn" onclick="showUpload()">è¿”å›ä¸Šä¼ </button></div>
            <div id="album-content" class="album-grid"></div>
            <div style="text-align: center; margin-top: 20px;"><a href="javascript:enableAdminMode()" class="admin-link">ğŸ”’ ç®¡ç†å‘˜å…¥å£</a></div>
        </div>
    </main>

    <script>
        // âœ… å·²ä¿®æ­£ï¼šå¡«å…¥äº†ä½ çš„çœŸå® Worker åŸŸå
        const WORKER_URL = 'https://pig.xiaohe.gv.uy/'; 
        
        const LOCAL_STORAGE_KEY = 'my_uploaded_images';
        const fileInput = document.getElementById('file-input');
        const dropArea = document.getElementById('drop-area');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInfo = document.getElementById('file-info');
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.getElementById('progress-fill');
        const resultArea = document.getElementById('result-area');
        const previewImg = document.getElementById('preview');
        const linkFormat = document.getElementById('link-format');
        const linkText = document.getElementById('link-text');
        const copyBtn = document.getElementById('copy-btn');
        const logMsg = document.getElementById('log-msg');
        let currentFile = null; let uploadedUrl = '';

        function log(msg, color='#666') { logMsg.textContent=msg; logMsg.style.color=color; }
        
        function showUpload() { document.getElementById('upload-view').style.display='block'; document.getElementById('album-view').style.display='none'; }
        async function showAlbum() {
            document.getElementById('upload-view').style.display='none'; document.getElementById('album-view').style.display='block';
            const content = document.getElementById('album-content');
            const localImages = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)||'[]');
            const params = new URLSearchParams(window.location.search);
            const key = params.get('key');

            if(key) {
                content.innerHTML='<p style="grid-column:1/-1;text-align:center;">åŠ è½½ä¸­...</p>';
                try {
                    const res = await fetch(`${WORKER_URL}album?key=${key}`);
                    if(res.status===403) { alert('å¯†ç é”™è¯¯'); renderImages(localImages); return; }
                    renderImages(await res.json());
                } catch(e) { renderImages(localImages); }
            } else { renderImages(localImages); }
        }

        function renderImages(imgs) {
            const el = document.getElementById('album-content');
            if(!imgs||!imgs.length) { el.innerHTML='<p style="grid-column:1/-1;text-align:center;color:#999;">æš‚æ— å›¾ç‰‡</p>'; return; }
            el.innerHTML='';
            [...imgs].reverse().forEach(img => {
                const d=document.createElement('div'); d.className='album-item';
                d.innerHTML=`<img src="${img.url}" loading="lazy"><div class="album-overlay">å¤åˆ¶é“¾æ¥</div>`;
                d.onclick=()=>{ navigator.clipboard.writeText(img.url); const o=d.querySelector('.album-overlay'); o.textContent='å·²å¤åˆ¶'; setTimeout(()=>o.textContent='å¤åˆ¶é“¾æ¥',1500); };
                el.appendChild(d);
            });
        }

        function enableAdminMode() { const k=prompt("è¾“å…¥å¯†ç æŸ¥çœ‹æ‰€æœ‰å›¾ç‰‡ï¼š"); if(k) window.location.href=window.location.pathname+'?key='+k; }
        function saveToLocal(url) { const i=JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)||'[]'); i.push({url,time:Date.now()}); localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(i)); }

        function handleFile(f) { if(!f.type.startsWith('image/')) return alert('ä»…é™å›¾ç‰‡'); currentFile=f; fileInfo.textContent=`å·²é€‰: ${f.name}`; uploadBtn.disabled=false; resultArea.style.display='none'; log(''); }
        fileInput.addEventListener('change', e=>{ if(e.target.files.length) handleFile(e.target.files[0]); });
        dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.style.borderColor='#f59e0b'; });
        dropArea.addEventListener('dragleave', e=>{ e.preventDefault(); dropArea.style.borderColor='#e5e7eb'; });
        dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.style.borderColor='#e5e7eb'; if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

        uploadBtn.addEventListener('click', () => {
            if(!currentFile) return;
            uploadBtn.disabled=true; progressBar.style.display='block'; progressFill.style.width='0%'; log('æ­£åœ¨ä¸Šä¼ ...', '#f59e0b');
            const xhr = new XMLHttpRequest();
            xhr.open('POST', WORKER_URL, true);
            xhr.upload.onprogress = e => { if(e.lengthComputable) progressFill.style.width = (e.loaded/e.total)*100 + '%'; };
            xhr.onload = () => {
                uploadBtn.disabled=false; progressBar.style.display='none';
                if(xhr.status===200) {
                    try {
                        const d = JSON.parse(xhr.responseText);
                        if(d.url) {
                            uploadedUrl=d.url; previewImg.src=uploadedUrl; resultArea.style.display='block';
                            updateLinkText(); saveToLocal(d.url); log('ä¸Šä¼ æˆåŠŸï¼', '#10b981');
                            fileInput.value=''; currentFile=null; fileInfo.textContent='';
                        } else log('é”™è¯¯', '#ef4444');
                    } catch(e) { log('è§£æå¤±è´¥', '#ef4444'); }
                } else log('å¤±è´¥: '+xhr.status, '#ef4444');
            };
            xhr.onerror = () => { uploadBtn.disabled=false; log('ç½‘ç»œé”™è¯¯', '#ef4444'); };
            const fd = new FormData(); fd.append('file', currentFile); xhr.send(fd);
        });

        function updateLinkText() {
            if(!uploadedUrl) return;
            const f = linkFormat.value;
            linkText.value = f==='bbcode'?`[img]${uploadedUrl}[/img]`: f==='markdown'?`![](${uploadedUrl})`: f==='html'?`<img src="${uploadedUrl}" />`: uploadedUrl;
        }
        linkFormat.addEventListener('change', updateLinkText);
        copyBtn.addEventListener('click', () => { linkText.select(); document.execCommand('copy'); const t=copyBtn.textContent; copyBtn.textContent='å·²å¤åˆ¶'; setTimeout(()=>copyBtn.textContent=t,1500); });
    </script>
</body>
</html>
